# entity-services-e2e

This directory contains an end-end scenario of how the Entity Services feature 
can be used for data integration.  Since Entity Services works in consort
with other MarkLogic features, the examples also demonstrate

* Data Movement.  A new part of the [Java Client API] which facilitates event-based
data flows.
* Template-Driven Extraction.  A declarative way to define locations within documents that are indexed as either tuples or RDF triples.
* Semantics model integration.  How to use RDF-based modeling technologies to work Entity services models.
* SQL.
* Optic API.  A query API for SQL-like access to tuples and triples, with Java,
 XQuery and JavaScript implementations.


There are several kinds of code here in the e2e directory.

* QConsole workspaces that contain XQuery scripting to demonstrate 
 the Entity Services API.
* Examples of code that has been generated, then edited are in directories under 
 `e2e-nwind/ml-modules/*`, schema and tde files under `e2e-nwind/ml-schemas/*`
* Java classes, with source under `src/main/java` demonstrate use of the Data
 Movement SDK for an Entity Services toolchain.

*Run all commands from this directory.  The e2e code will not deploy to
MarkLogic if run from the parent project's directory.*


Deploying E2e Code
----------------------

e2e-nwind has database configuration and stub code under `e2e-nwind` directory.  To load the code run

`./gradlew mldeploy` or `./gradlew -PexampleDir=e2e-nwind mlDeploy`


To clean up and remove those apps and databases, run

`./gradlew mlundeploy` or `./gradlew -PexampleDir=e2e-nwind mlUnDeploy`

To change the location of the deployment edit `gradle.properties` *and* check
`src/main/resources/application.properties` to make it match.

When you deploy, the following happens:

* Databases and forests are provisioned and configured.
* Database properties like range-index and word-lexicon definitions are applied
 from `e2e-nwind/ml-config/databases`. This configuration was generated by Entity
 Services.
* Entity Services code modules to go from `e2e-nwind/ml-modules/ext` to the
 REST extension space.  This code was created from stubs generated by Entity 
 Services with little edit to XPaths in the code generated.
* Transforms go from `e2e-nwind/ml-modules/transforms` to REST config.  These
 transforms wrap calls to the Entity Services modules, but were authored by
 a developer.
* Search options are installed from `e2e-nwind/ml-modules/options` to REST.
 This configuration was generated by Entity Services.
* A module to generate code is installed from `e2e-nwind/ml-modules/services`
 to REST.  This extension is just used by the e2e code to invoke the
 Entity Services API as a demonstration.  It was written by the e2e developer,
 and isn't part of the e2e data integration per se.
* Schemas that can validate canonical instance data are installed from
 `e2e-nwind/ml-schemas` to the schemas database. It is a somewhat modified version
 of one generated by Entity Services out-of-the-box.
* Extraction templates that index canonical instance data is installed
 from `e2e-nwind/ml-schemas` to the schemas database in the proper TDE
 collection.  It is a somewhat modified version of one generated by Entity
 Services.

Running E2e
----------------

E2e is run as gradle tasks.  You'll see a task rune2eNwind when
you invoke `./gradlew tasks`.

See the individual e2e directory for more information.


QConsole Workspaces
-------------------

The e2e-nwind has exported QConsole workspace.  This workspace has sample
queries to help interpret what the data integration scenario looks like.

Import the workspace `nwind-qc.xml` from QConsole, and step through the tabs,
each of which show something about what your simulated data hub accomplished.


Generating Code
---------------

If you have models loaded in the database, you can invoke the Entity Services code-generation API with `./gradlew genCode`.

This task iterates through models in the database and creates the code
generation artifcats for use in applications (which were the sources for
e2e code).  These artifacts are placed in the `gen` directory.
